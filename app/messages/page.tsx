"use client";

import { useState, useRef, useEffect, useMemo } from "react";
import { Search, Phone, Video, MoreHorizontal, Paperclip, Smile, Send } from "lucide-react";
import Header from "../news/ui/header/page";
import style from "./messages.module.css";
import { cn } from "@/lib/utils";

interface Chat {
    id: string;
    name: string;
    avatar: string;
    lastMessage: string;
    time: string;
    unread: number;
    isOnline: boolean;
}

interface Message {
    id: string;
    text: string;
    time: string;
    isOwn: boolean;
}

export default function MessagesPage() {
    const [selectedChat, setSelectedChat] = useState<string>("1");
    const [newMessage, setNewMessage] = useState("");
    const [isTyping, setIsTyping] = useState(false);
    const messagesEndRef = useRef<HTMLDivElement>(null);

    const chats: Chat[] = [
        {
            id: "1",
            name: "–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞",
            avatar: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face",
            lastMessage: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞ —Å –Ω–æ–≤—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º?",
            time: "14:23",
            unread: 2,
            isOnline: true
        },
        {
            id: "2",
            name: "–ú–∞–∫—Å–∏–º –í–æ–ª–∫–æ–≤",
            avatar: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face",
            lastMessage: "–û—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–±–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–≤—å—é",
            time: "13:45",
            unread: 0,
            isOnline: true
        },
        {
            id: "3",
            name: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞",
            avatar: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face",
            lastMessage: "–£–≤–∏–¥–∏–º—Å—è –∑–∞–≤—Ç—Ä–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á–µ!",
            time: "12:30",
            unread: 0,
            isOnline: false
        },
        {
            id: "4",
            name: "–î–º–∏—Ç—Ä–∏–π –°–∏–¥–æ—Ä–æ–≤",
            avatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face",
            lastMessage: "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å! üëç",
            time: "11:15",
            unread: 1,
            isOnline: false
        },
        {
            id: "5",
            name: "–û–ª—å–≥–∞ –ò–≤–∞–Ω–æ–≤–∞",
            avatar: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=150&h=150&fit=crop&crop=face",
            lastMessage: "–ú–æ–∂–µ–º –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞?",
            time: "10:45",
            unread: 0,
            isOnline: true
        },
        {
            id: "6",
            name: "–ò–≥–æ—Ä—å –ö–æ–∑–ª–æ–≤",
            avatar: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face",
            lastMessage: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ",
            time: "09:20",
            unread: 0,
            isOnline: false
        }
    ];

    const messages = useMemo<{ [chatId: string]: Message[] }>(() => ({
        "1": [
            {
                id: "1",
                text: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞ —Å –Ω–æ–≤—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º?",
                time: "14:20",
                isOwn: false
            },
            {
                id: "2",
                text: "–ü—Ä–∏–≤–µ—Ç! –í—Å–µ –æ—Ç–ª–∏—á–Ω–æ, –ø–æ—á—Ç–∏ –∑–∞–∫–æ–Ω—á–∏–ª –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É",
                time: "14:21",
                isOwn: true
            },
            {
                id: "3",
                text: "–•–æ—á–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é?",
                time: "14:21",
                isOwn: true
            },
            {
                id: "4",
                text: "–ö–æ–Ω–µ—á–Ω–æ! –û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
                time: "14:23",
                isOwn: false
            }
        ],
        "2": [
            {
                id: "1",
                text: "–û—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–±–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–µ–≤—å—é",
                time: "13:40",
                isOwn: false
            },
            {
                id: "2",
                text: "–ü—Ä–æ–≤–µ—Ä—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –º–∞–∫–µ—Ç—ã –∏ –¥–∞–π —Ñ–∏–¥–±–µ–∫",
                time: "13:41",
                isOwn: false
            },
            {
                id: "3",
                text: "–û—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ü–æ—Å–º–æ—Ç—Ä—é –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞",
                time: "13:45",
                isOwn: true
            }
        ],
        "3": [
            {
                id: "1",
                text: "–£–≤–∏–¥–∏–º—Å—è –∑–∞–≤—Ç—Ä–∞ –Ω–∞ –≤—Å—Ç—Ä–µ—á–µ!",
                time: "12:30",
                isOwn: false
            },
            {
                id: "2",
                text: "–î–∞, –¥–æ –≤—Å—Ç—Ä–µ—á–∏! –í 10:00 –∫–∞–∫ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–ª–∏—Å—å",
                time: "12:32",
                isOwn: true
            }
        ]
    }), []);

    const currentChat = chats.find(chat => chat.id === selectedChat);
    const currentMessages = useMemo(() => messages[selectedChat] || [], [messages, selectedChat]);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(() => {
        scrollToBottom();
    }, [currentMessages]);

    const handleSendMessage = () => {
        if (newMessage.trim()) {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            console.log("Sending message:", newMessage);
            setNewMessage("");
        }
    };

    const handleKeyPress = (e: React.KeyboardEvent) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    };

    return (
        <>
            <Header />
            <div className={style.mainContainer}>
                <div className={style.messagesLayout}>
                    <div className={style.messagesSidebar}>
                        <div className={style.messagesSidebarHeader}>
                            <h1 className={style.messagesTitle}>–°–æ–æ–±—â–µ–Ω–∏—è</h1>
                            <div className={style.messagesSearch}>
                                <Search className={style.messagesSearchIcon} size={16} />
                                <input
                                    type="text"
                                    placeholder="–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π..."
                                    className={style.messagesSearchInput}
                                />
                            </div>
                        </div>

                        <div className={style.messagesList}>
                            {chats.map((chat) => (
                                <div
                                    key={chat.id}
                                    className={cn(style.chatItem, selectedChat === chat.id && style.active)}
                                    onClick={() => setSelectedChat(chat.id)}
                                >
                                    <div className={style.chatAvatarContainer}>
                                        <img
                                            src={chat.avatar}
                                            alt={chat.name}
                                            className={style.chatAvatar}
                                        />
                                        <div className={cn(style.chatStatusIndicator, chat.isOnline ? style.online : style.offline)}></div>
                                    </div>

                                    <div className={style.chatInfo}>
                                        <div className={style.chatName}>{chat.name}</div>
                                        <div className={style.chatLastMessage}>{chat.lastMessage}</div>
                                    </div>

                                    <div className={style.chatMeta}>
                                        <div className={style.chatTime}>{chat.time}</div>
                                        {chat.unread > 0 && (
                                            <div className={style.chatUnread}>{chat.unread}</div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className={style.messagesMain}>
                        {currentChat && (
                            <>
                                <div className={style.messagesHeader}>
                                    <div className={style.messagesHeaderInfo}>
                                        <img
                                            src={currentChat.avatar}
                                            alt={currentChat.name}
                                            className={style.messagesHeaderAvatar}
                                        />
                                        <div className={style.messagesHeaderDetails}>
                                            <h3>{currentChat.name}</h3>
                                            <p>{currentChat.isOnline ? "–í —Å–µ—Ç–∏" : "–ë—ã–ª –≤ —Å–µ—Ç–∏ –Ω–µ–¥–∞–≤–Ω–æ"}</p>
                                        </div>
                                    </div>

                                    <div className={style.messagesHeaderActions}>
                                        <button className={style.messagesActionButton}>
                                            <MoreHorizontal size={16} />
                                        </button>
                                    </div>
                                </div>

                                <div className={style.messagesContent}>
                                    {currentMessages.map((message, index) => {
                                        const isGrouped = index > 0 &&
                                            currentMessages[index - 1].isOwn === message.isOwn;

                                        return (
                                            <div
                                                key={message.id}
                                                className={cn(style.messageGroup, message.isOwn ? style.own : style.other)}
                                            >
                                                <div className={cn(style.messageBubble, message.isOwn ? style.own : style.other)}>
                                                    <div className={style.messageText}>{message.text}</div>
                                                    <div className={style.messageTime}>{message.time}</div>
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {isTyping && (
                                        <div className={cn(style.messageGroup, style.other)}>
                                            <div className={style.typingIndicator}>
                                                <div className={style.typingDots}>
                                                    <div className={style.typingDots}></div>
                                                    <div className={style.typingDots}></div>
                                                    <div className={style.typingDots}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div ref={messagesEndRef} />
                                </div>
                                <div className={style.messagesInputContainer}>
                                    <div className={style.messagesInputWrapper}>
                                        <textarea
                                            value={newMessage}
                                            onChange={(e) => setNewMessage(e.target.value)}
                                            onKeyPress={handleKeyPress}
                                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                            className={style.messagesInput}
                                            rows={1}
                                        />

                                        <div className={style.messagesInputActions}>
                                            <button className={style.messagesInputButton}>
                                                <Paperclip size={16} />
                                            </button>
                                            <button className={style.messagesInputButton}>
                                                <Smile size={16} />
                                            </button>
                                            <button
                                                className={style.messagesSendButton}
                                                onClick={handleSendMessage}
                                                disabled={!newMessage.trim()}
                                            >
                                                <Send size={16} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            </div>
        </>
    );
}